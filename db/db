DROP DATABASE IF EXISTS BAP_spring;
CREATE DATABASE BAP_spring;
USE BAP_spring;
SHOW TABLES;

#host 테이블 생성
CREATE TABLE `member` (
	id INT(10) UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
	regDate DATETIME NOT NULL,
	updateDate DATETIME NOT NULL,
	memberType CHAR(20) NOT NULL,
	loginId CHAR(20) NOT NULL,
	loginPw CHAR(20) NOT NULL,
	`authLevel` SMALLINT(2) UNSIGNED DEFAULT 3 COMMENT '권한레벨(3=일반, 7=관리자)',
	`name` CHAR(20) NOT NULL,
	cellphoneNo CHAR(20) NOT NULL,
	email CHAR(50) NOT NULL,
	delStatus TINYINT(1) UNSIGNED NOT NULL DEFAULT 0 COMMENT '탈퇴여부(0=탈퇴전, 1=탈퇴)',
	delDate DATETIME COMMENT '탈퇴날짜'
);

# host 테스트 데이터 생성
INSERT INTO `member`
SET regDate = NOW(),
updateDate = NOW(),
memberType = 'host',
loginId = 'host1',
loginPw = 'host1',
`name` = '호스트1',
cellphoneNo = '010-1234-5678',
email = 'host1@gmail.com';

INSERT INTO `member`
SET regDate = NOW(),
updateDate = NOW(),
memberType = 'host',
loginId = 'host2',
loginPw = 'host2',
`name` = '호스트2',
cellphoneNo = '010-1234-5678',
email = 'host2@gmail.com';

INSERT INTO `member`
SET regDate = NOW(),
updateDate = NOW(),
memberType = 'host',
loginId = 'host3',
loginPw = 'host3',
`name` = '호스트3',
cellphoneNo = '010-1234-5678',
email = 'host3@gmail.com';

INSERT INTO `member`
SET regDate = NOW(),
updateDate = NOW(),
memberType = 'guest',
loginId = 'admin',
loginPw = 'admin',
`authLevel` = 7,
`name` = '관리자',
cellphoneNo = '010-1234-5678',
email = 'admin@gmail.com';

INSERT INTO `member`
SET regDate = NOW(),
updateDate = NOW(),
memberType = 'guest',
loginId = 'guest1',
loginPw = 'guest1',
`name` = '게스트1',
cellphoneNo = '010-1234-5678',
email = 'guest1@gmail.com';

INSERT INTO `member`
SET regDate = NOW(),
updateDate = NOW(),
memberType = 'guest',
loginId = 'guest2',
loginPw = 'guest2',
`name` = '게스트2',
cellphoneNo = '010-1234-5678',
email = 'guest2@gmail.com';

# company 테이블 생성
CREATE TABLE company (
	id INT(10) UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
	regDate DATETIME NOT NULL,
	updateDate DATETIME NOT NULL,
	`name` CHAR(50) NOT NULL,
	address CHAR(50) NOT NULL
);

# company 테스트 데이터 생성
INSERT INTO company
SET regDate = NOW(),
updateDate = NOW(),
`name` = '신라호텔',
address = '서울시 중구 동호로249';

INSERT INTO company
SET regDate = NOW(),
updateDate = NOW(),
`name` = '롯데시티호텔',
address = '대전 유성구 엑스포로123번길';

INSERT INTO company
SET regDate = NOW(),
updateDate = NOW(),
`name` = '호텔 오노마 대전 오토그래프 컬렉션',
address = '대전 유성구 도룡동 3-1';

INSERT INTO company
SET regDate = NOW(),
updateDate = NOW(),
`name` = '양평 로즈데일',
address = '경기 양평군 단월면 명성리 162';

INSERT INTO company
SET regDate = NOW(),
updateDate = NOW(),
`name` = '청주 브라운도트',
address = '충북 청주시 상당구 북문로2가 106-1';

INSERT INTO company
SET regDate = NOW(),
updateDate = NOW(),
`name` = '제주 쉬멍놀멍 게스트하우스',
address = '제주특별자치도 제주시 한림읍 협재리 2557-1';

# product 테이블 생성
CREATE TABLE product (
	id INT(10) UNSIGNED NOT NULL PRIMARY KEY AUTO_INCREMENT,
	regDate DATETIME NOT NULL,
	updateDate DATETIME NOT NULL,
	companyId INT(10) UNSIGNED NOT NULL,
	accommodationType CHAR(20) NOT NULL,
	roomType CHAR(20) NOT NULL,
	image_path VARCHAR (255) NOT NULL,
	numberOfRooms INT(10) NOT NULL,
	hostId INT(10) NOT NULL,
	fee INT(100) NOT NULL,
	countOfRoom INT(100) UNSIGNED NOT NULL,
	countOfAdult INT(100) UNSIGNED NOT NULL,
	countOfChild INT(100) UNSIGNED NOT NULL,
	includeMeals CHAR(20) NOT NULL
);

# product 테스트 데이터 생성
INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '1',
accommodationType = '호텔',
roomType = '스탠다드',
numberOfRooms = 7,
hostId = 1,
fee = 100000,
countOfRoom = 1,
countOfAdult = 2,
countOfChild = 1,
includeMeals = '조식, 석식';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '2',
accommodationType = '호텔',
roomType = '디럭스',
numberOfRooms = 4,
hostId = 2,
fee = 70000,
countOfRoom = 1,
countOfAdult = 2,
countOfChild = 1,
includeMeals = '조식';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '2',
accommodationType = '호텔',
roomType = '스탠다드',
numberOfRooms = 1,
hostId = 2,
fee = 50000,
countOfRoom = 1,
countOfAdult = 4,
countOfChild = 1,
includeMeals = '조식';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '2',
accommodationType = '호텔',
roomType = '스위트',
numberOfRooms = 3,
hostId = 2,
fee = 90000,
countOfRoom = 1,
countOfAdult = 2,
countOfChild = 1,
includeMeals = '식사불포함';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '3',
accommodationType = '호텔',
roomType = '디럭스',
numberOfRooms = 2,
hostId = 3,
fee = 239000,
countOfRoom = 1,
countOfAdult = 2,
countOfChild = 1,
includeMeals = '조식, 석식';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '4',
accommodationType = '펜션',
roomType = '산토리니',
numberOfRooms = 1,
hostId = 4,
fee = 125000,
countOfRoom = 1,
countOfAdult = 4,
countOfChild = 4,
includeMeals = '식사불포함';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '5',
accommodationType = '모텔',
roomType = '스위트',
numberOfRooms = 4,
hostId = 5,
fee = 65000,
countOfRoom = 1,
countOfAdult = 2,
countOfChild = 1,
includeMeals = '식사불포함';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '5',
accommodationType = '모텔',
roomType = '디럭스',
numberOfRooms = 6,
hostId = 5,
fee = 50000,
countOfRoom = 1,
countOfAdult = 2,
countOfChild = 1,
includeMeals = '식사불포함';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '5',
accommodationType = '모텔',
roomType = '스탠다드',
numberOfRooms = 2,
hostId = 5,
fee = 35000,
countOfRoom = 1,
countOfAdult = 2,
countOfChild = 1,
includeMeals = '식사불포함';

INSERT INTO product
SET regDate = NOW(),
updateDate = NOW(),
companyId = '6',
accommodationType = '게스트하우스',
roomtype = '트윈룸(3인타입)',
numberOfRooms = 2,
fee = 72000,
countOfRoom = 1,
countOfAdult = 3,
countOfChild = 0,
includeMeals = '조식';

SELECT * FROM product;

# 쿼리 테스트(jh)
SELECT P.*,
C.name AS comName, 
C.address AS comAddr
FROM product AS P
INNER JOIN company AS C
ON P.companyId = C.id
GROUP BY P.companyId;

SELECT *
FROM product
WHERE companyId = 2;

# 쿼리 테스트(ss)
	
SELECT p.*,
C.name,
C.address,
MIN(fee) AS extra__minFee
FROM product AS P
INNER JOIN company AS C
ON P.companyId = C.id
GROUP BY C.NAME, C.address
ORDER BY extra__minFee ASC;
-- 
-- SELECT p.*,
-- MIN(fee) AS extra__minFee
-- FROM product AS p
-- WHERE 1
-- AND accommodationType = '호텔' OR accommodationType = '모텔'
-- GROUP BY NAME, address
-- ORDER BY extra__minFee ASC;

SHOW TABLES;
SELECT * FROM product;
SELECT * FROM company;

# genFile 테이블 추가
CREATE TABLE genFile (
  id INT(10) UNSIGNED NOT NULL AUTO_INCREMENT, # 번호
  regDate DATETIME DEFAULT NULL, # 작성날짜
  updateDate DATETIME DEFAULT NULL, # 갱신날짜
  delDate DATETIME DEFAULT NULL, # 삭제날짜
  delStatus TINYINT(1) UNSIGNED NOT NULL DEFAULT 0, # 삭제상태(0:미삭제,1:삭제)
  relTypeCode CHAR(50) NOT NULL, # 관련 데이터 타입(article, member)
  relId INT(10) UNSIGNED NOT NULL, # 관련 데이터 번호
  originFileName VARCHAR(100) NOT NULL, # 업로드 당시의 파일이름
  fileExt CHAR(10) NOT NULL, # 확장자
  typeCode CHAR(20) NOT NULL, # 종류코드 (common)
  type2Code CHAR(20) NOT NULL, # 종류2코드 (attatchment)
  fileSize INT(10) UNSIGNED NOT NULL, # 파일의 사이즈
  fileExtTypeCode CHAR(10) NOT NULL, # 파일규격코드(img, video)
  fileExtType2Code CHAR(10) NOT NULL, # 파일규격2코드(jpg, mp4)
  fileNo SMALLINT(2) UNSIGNED NOT NULL, # 파일번호 (1)
  fileDir CHAR(20) NOT NULL, # 파일이 저장되는 폴더명
  PRIMARY KEY (id),
  KEY relId (relTypeCode,relId,typeCode,type2Code,fileNo)
);

# company 테이블 수정
ALTER TABLE company ADD COLUMN accommodationType CHAR(10) NOT NULL;
ALTER TABLE company ADD COLUMN host_id INT(10) UNSIGNED NOT NULL;

UPDATE company
SET accommodationType = 'hotel',
host_id = 1
WHERE id = 1;

UPDATE company
SET accommodationType = 'hotel',
host_id = 2
WHERE id = 2;

UPDATE company
SET accommodationType = 'hotel',
host_id = 3
WHERE id = 3;

UPDATE company
SET accommodationType = 'pension',
host_id = 4
WHERE id = 4;

UPDATE company
SET accommodationType = 'motel',
host_id = 5
WHERE id = 5;

UPDATE company
SET accommodationType = 'guesthouse',
host_id = 6,
`name` = '제주 쉬멍놀멍 게스트하우스',
address = '제주특별자치도 제주시 한림읍 협재리 2557-1'
WHERE id = 6;

SELECT * FROM company;

# product 테이블 수정
ALTER TABLE product DROP COLUMN accommodationType;
ALTER TABLE product DROP COLUMN hostId;
ALTER TABLE product CHANGE COLUMN companyId comp_id INT(10) UNSIGNED NOT NULL;
SELECT * FROM product;

SELECT c.*,
MIN(fee) AS extra_minFee
FROM company AS c
LEFT JOIN product AS p
ON c.id = p.comp_id
GROUP BY c.id;

SELECT * FROM MEMBER;
SELECT * FROM company;

# 로그인비밀번호 컬럼의 길이를 100으로 늘림
ALTER TABLE `member` MODIFY COLUMN loginPw VARCHAR(100) NOT NULL;

# 기존 회원의 비밀번호를 암호화하여 저장
UPDATE `member`
SET loginPw = SHA2(loginPw, 256);

SELECT * FROM `member`;
SELECT * FROM product;

SELECT *
FROM product
WHERE comp_id = 2;

SELECT *
FROM  product
WHERE includeMeals = '식사불포함'
OR includeMeals = '조식';

SELECT *
FROM (SELECT *
		FROM  product
		WHERE includeMeals = '식사불포함'
		OR includeMeals = '조식'
		OR includeMeals = '석식'
		OR includeMeals = '조식, 석식') AS `PI`
LEFT JOIN product AS pc
ON `PI`.id = PC.id
WHERE PC.comp_id = 2;
					